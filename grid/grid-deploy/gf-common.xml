<?xml version="1.0" encoding="UTF-8"?>
<project name="gf-common" basedir="."
	 xmlns:dav="antlib:org.apache.webdav.ant"
	 xmlns:caroline="antlib:com.sun.caroline.tools.carolant">

  <property name="service.base" value="glassfishv3-prelude"/>

  <import file="web-common.xml"/>

  <property name="domain" value="aura"/>
  <property name="domain.dir" value="${service.working}/glassfish/domains/${domain}"/>
  <property name="service.conf" value="${www.filesystem}/${service.base}/glassfish/domains/${domain}/config/"/>

  <!-- We only need to copy the ant build file to unzip the distribution -->
  <target name="copy-support-files" description="Copy the build support files from the dist directory into the www filesystem" depends="upload-distribution,update-config">
    <dav:copy url="${config.url}/unzip-dist.xml"
	      destination="${dav.url}/${www.filesystem}/unzip-dist.xml"
	      verbose="true"
	      overwrite="true"
	      userid="${user}" password="${pw}"/>
    <dav:copy url="${config.url}/asadmin.pass"
	      destination="${dav.url}/${www.filesystem}/asadmin.pass"
	      verbose="true"
	      overwrite="true"
	      userid="${user}" password="${pw}"/>
  </target>

  <target name="update-config" description="updates service configuration">
    <dav:mkcol url="${dav.url}/${service.conf}"
	      verbose="true"
	      userid="${user}" password="${pw}"/>
    <dav:copy url="${config.url}/domain.xml"
	      destination="${dav.url}/${www.filesystem}/unzip-dist.xml"
	      verbose="true"
	      overwrite="true"
	      userid="${user}" password="${pw}"/>
  </target>

  <!-- Deploy a war file on-grid -->
  <target name="deploy-war"
	  description="Deploys a war file on the grid"
	  depends="upload-war,create-deploy-intaddress,copy-support-files">

    <!-- Creates and starts a Caroline process to run ant and have it deploy
	 the war file -->
    <caroline:process name="deploy-task" op="create"
		      workingdir="/files/working"
		      duration="task">
      <!-- Filesystems to mount -->
      <caroline:filesystem name="${www.filesystem}" mountpoint="working"/>
      <caroline:filesystem name="${dist.filesystem}" mountpoint="dist"/>
      <caroline:filesystem name="${packages.filesystem}" mountpoint="sys.packages"/>
      <!-- An address, since we need to talk to the servers -->
      <caroline:intaddress name="deploy-int" networkname="${network}"/>
      <!-- Set environment variables -->
      <env key="AS_INSTALL" value="/files/working/glassfish"/>
      <env key="AS_INSTALL_LIB" value="/files/working/glassfish/modules"/>
      <!-- Specify the command line -->
      <arg value="-jar"/>
      <arg value="/files/working/${service.base}/glassfish/modules/admin-cli.jar"/>
      <arg value="deploy"/>
      <arg value="--host"/>
      <arg value="${service.process}"/>
      <arg value="--user"/>
      <arg value="admin"/>
      <arg value="--passwordfile"/>
      <arg value="/files/working/asadmin.pass"/>
      <arg value="--contextroot"/>
      <arg value="${war.path}"/>
      <arg value="--force"/>
      <arg value="true"/>
      <arg value="/files/dist/web/${deployment.name}/${war.file}"/>
    </caroline:process>
  </target>
  
  <!-- Undeploy a war file on-grid -->
  <target name="undeploy-war"
	  description="Deploys a war file on the grid"
	  depends="create-deploy-intaddress">

    <!-- Creates and starts a Caroline process to run ant and have it deploy
	 the war file -->
    <caroline:process name="deploy-task" op="create"
		      workingdir="/files/working"
		      duration="task">
      <!-- Filesystems to mount -->
      <caroline:filesystem name="${www.filesystem}" mountpoint="working"/>
      <caroline:filesystem name="${dist.filesystem}" mountpoint="dist"/>
      <caroline:filesystem name="${packages.filesystem}" mountpoint="sys.packages"/>
      <!-- An address, since we need to talk to the servers -->
      <caroline:intaddress name="deploy-int" networkname="${network}"/>
      <!-- Set environment variables -->
      <env key="AS_INSTALL" value="/files/working/glassfish"/>
      <env key="AS_INSTALL_LIB" value="/files/working/glassfish/modules"/>
      <!-- Specify the command line -->
      <arg value="-jar"/>
      <arg value="/files/working/${service.base}/glassfish/modules/admin-cli.jar"/>
      <arg value="undeploy"/>
      <arg value="--user"/>
      <arg value="admin"/>
      <arg value="--passwordfile"/>
      <arg value="/files/working/asadmin.pass"/>
      <arg value="${war.path}"/>
    </caroline:process>
  </target>

</project>