<?xml version="1.0" encoding="UTF-8"?>
<project name="www" default="upload-dist" basedir="."
    xmlns:dav="antlib:org.apache.webdav.ant"
    xmlns:caroline="antlib:com.sun.caroline.tools.carolant">
                          
    <!-- Where the libraries are -->
    <property name="tool.libraries" value="../../ToolLibraries"/>

    <!-- Declare the Caroline tasks -->
    <taskdef resource="com/sun/caroline/tools/carolant/antlib.xml"
            uri="antlib:com.sun.caroline.tools.carolant">
        <classpath>
            <pathelement location="${tool.libraries}/carolant.jar"/>
            <pathelement location="${tool.libraries}/caroline.jar"/>
        </classpath>
    </taskdef>
        
   <!-- Declare the Caroline Ant tasks -->
    <taskdef resource="org/apache/webdav/ant/antlib.xml" uri="antlib:org.apache.webdav.ant">
        <classpath>
            <pathelement location="${tool.libraries}/jakarta-slide-ant-webdav-2.2pre1.jar"/>
            <pathelement location="${tool.libraries}/jakarta-slide-webdavlib-2.2pre1.jar"/>
            <pathelement location="${tool.libraries}/commons-httpclient.jar"/>
            <pathelement location="${tool.libraries}/commons-logging.jar"/>
            <pathelement location="${tool.libraries}/jdom-1.0.jar"/>
        </classpath>
    </taskdef>
    
    <loadproperties srcfile="${user.home}${file.separator}.caroline">
        <filterchain>
            <prefixlines prefix="grid."/>
        </filterchain>
    </loadproperties>

    <!-- create a grid adapter instance to retrieve a reference the grid -->
    <caroline:grid/>

    <!-- use implicit properties set by the grid adapter above-->    
    <property name="user" value="${com.sun.caroline.customerID}"/>
    <property name="pw" value="${com.sun.caroline.password}"/>
    <property name="grid.url" value="${com.sun.caroline.gridURL}"/>   
    <property name="dav.url" value="${grid.url}/${user}"/>
    
    <!-- A webdav URL for the dist filesystem. -->
    <property name="dist.url" value="${dav.url}/${grid.instance}-aura.dist"/>
    
    <!-- Where the Ant libraries are -->
    <property name="ant.lib" value="${tool.libraries}/ant-lib"/>
    
    <!-- The name of the system packages file system -->
    <property name="packages.filesystem" value="sys.packages"/>   
     
    <!-- The name of the code filesystem on grid. -->
    <property name="code.filesystem" value="${grid.instance}-aura.dist"/>
    
    <!-- properties to hold resource names -->
    <property name="dist.col" value="${code.filesystem}/dist"/>
    <property name="jini.col" value="${code.filesystem}/jini"/>
    
    <!-- Upload Resources to Caroline filesystems -->
    
    <!-- create a caroline filesystem to upload the Ant jars to -->
    <target name="create-filesystems" 
        description="creates filesystems needed for the code">         
        <caroline:filesystem name="${packages.filesystem}" op="create"/>             
        <caroline:filesystem name="${code.filesystem}" op="create"/>             
    </target>
    
    <!-- create a WebDAV collection to upload Ant jars to-->
    <target name="create-dist-collections" description="creates Ant package" depends="create-filesystems">
        <dav:mkcol url="${dav.url}/${dist.col}" userid="${user}" password="${pw}"/>            
        <dav:mkcol url="${dav.url}/${jini.col}" userid="${user}" password="${pw}"/>            
    </target>
    
    <target name="upload-grid" description="Uploads grid jar file">
        <dav:put url="${dav.url}/${dist.col}" userid="${user}" password="${pw}" lock="false">            
            <!-- Distribution jar -->
            <fileset dir="../dist">
                <include name="grid.jar"/>
            </fileset>
        </dav:put>    
    </target>
    
    <!-- builds the aardvark distribution jar, then uploads the results.-->
    <target name="upload-dist" description="Uploads distribution files" depends="create-dist-collections">
        <ant dir="../../aardvark" antfile="build.xml" target="make-dist-jar-dir"/>
        <dav:put url="${dav.url}/${dist.col}" userid="${user}" password="${pw}" lock="false">            
            <!-- Distribution jar -->
            <fileset dir="../../aardvark/dist/dist">
                <include name="**/*.jar"/>
                <include name="**/*.policy"/>
            </fileset>
            <fileset dir="../dist">
                <include name="grid.jar"/>
            </fileset>
            <fileset dir="../../aura/dist">
                <include name="aura.jar"/>
            </fileset>
        </dav:put>    
        <dav:put url="${dav.url}/${jini.col}" userid="${user}" password="${pw}" lock="false">            
            <!-- Jini libraries -->
            <fileset dir="../../Libraries/jini">
                <include name="**/*"/>
            </fileset>           
        </dav:put>    
    </target>
</project>